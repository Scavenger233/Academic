# Lec 10 SQL stored procedures
## PSM persistent stored modules
- Procedure(no return value)
  - ```sql
    CREATE PROCEDURE name(parameter list);
    ```
- Function( with a return value)
  - ```sql
    CREATE FUNCTION name(parameter list)
    RETURN type;
    ```
### Parameters in PSM
- mode-name-type triples
- mode can be:
  - IN : uses value, no value change
  - OUT : no use, procedure changes
  - INOUT: both
 
# Involing procedure
```sql
CALL someProcedure;
```

### Statements in PSM
```sql
--DECLARATION
  DECLARE name type;

  DECLARE total INT;

--BEGIN & END
CREATE FUNCTION CalculateTotal (price DECIMAL, qty INT) RETURNS DECIMAL
  BEGIN
      DECLARE total DECIMAL;
      SET total = price * qty; -- Multiply price and quantity
      RETURN total; -- Set the return value (but function continues)
  END;
--ASSIGNMENT STATEMENT
  SET x = 'Limerick';

--LABEL USE
  BEGIN
    DECLARE x INT DEFAULT 0;

    loop_label: WHILE x < 5 DO
        SET x = x + 1;
        IF x = 3 THEN
            LEAVE loop_label; -- Exit the loop when x = 3
        END IF;
    END WHILE;

  END;

--IF STATEMENT
IF x > 10 THEN
    SET y = 20; -- Executes if x > 10
ELSEIF x = 10 THEN
    SET y = 15; -- Executes if x = 10
ELSE
    SET y = 5; -- Executes if x < 10
END IF;
```

### Explanation of Queries in PSM

In **Persistent Stored Modules (PSM)**, general `SELECT-FROM-WHERE` queries cannot be used as standalone statements. Instead, you have three ways to use them:

---

### 1. **Queries Producing One Value (Assignment):**
   - Use a query that produces a single value in an **assignment statement**.
   - Example:
     ```sql
     SET total_sales = (SELECT SUM(quantity) FROM Sales WHERE model = 'L123');
     ```
     **Explanation:**
     - The query calculates the total sales for a specific model (`'L123'`).
     - The result is assigned to the variable `total_sales`.

---

### 2. **Single-Row SELECT INTO:**
   - Use `SELECT ... INTO` to assign values directly to variables when the query returns **one row**.
   - Example:
     ```sql
     SELECT price INTO laptop_price FROM Laptops WHERE model = 'L123';
     ```
     **Explanation:**
     - The query fetches the `price` of the model `'L123'`.
     - The result is stored in the variable `laptop_price`.

---

### 3. **Cursors:**
   - Use **cursors** for queries that return multiple rows. Cursors allow you to process rows one at a time.
   - Example:
     ```sql
     DECLARE cursor_name CURSOR FOR SELECT model, price FROM Laptops;
     OPEN cursor_name;
     FETCH cursor_name INTO model_var, price_var;
     CLOSE cursor_name;
     ```
     **Explanation:**
     - A cursor is declared for a query that retrieves multiple rows.
     - The cursor is opened, rows are fetched into variables (`model_var`, `price_var`), and then the cursor is closed.

---

### Summary:
- Use **assignments** for queries returning a single value.
- Use **SELECT INTO** for queries returning one row.
- Use **cursors** for queries returning multiple rows.
